<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Interactive Bubble Chart</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #f4f6fa;
        }
        #chart {
            width: 100%;
            height: 110vh;
            background-color: #fff;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
            position: relative;
            margin: 32px auto 0 auto;
            max-width: 1800px;
        }
        .bubble {
            stroke: #fff;
            stroke-width: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .bubble:hover {
            opacity: 0.9;
            stroke-width: 3px;
            filter: brightness(1.1);
        }
        .domain-label {
            font-size: 20px;
            font-weight: bold;
            fill: #2c3e50;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.9);
            pointer-events: none;
        }
        .subdomain-label {
            fill: #34495e;
            font-weight: 500;
            pointer-events: none;
        }
        .subdomain-amount {
            font-size: 12px;
            fill: #f8f9fa;
            font-weight: 600;
            pointer-events: none;
        }
        .stats-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.97);
            padding: 15px;
            border-radius: 8px;
            font-size: 13px;
            color: #555;
            max-width: 220px;
            border: 1px solid #e0e0e0;
        }
        #download-svg-btn, #download-html-btn {
            background:#3498db;
            color:white;
            padding:8px 16px;
            border:none;
            border-radius:6px;
            cursor:pointer;
            font-size:14px;
            margin-right:8px;
            margin-top:10px;
        }
        #download-svg-btn:hover, #download-html-btn:hover {
            background: #2980b9;
        }
        .tooltip {
            position: absolute;
            text-align: center;
            width: 120px;
            height: auto;
            padding: 8px;
            font: 12px sans-serif;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
    </style>
</head>
<body>
<div id="chart">
    <div class="stats-panel" id="stats"></div>
    <button id="download-svg-btn">Download SVG</button>
    <button id="download-html-btn">Download HTML</button>
</div>
<script>
/*DATA_PLACEHOLDER*/

let currentData = null;
let svg = null;

function initializeChart() {
    const container = document.getElementById('chart');
    const containerRect = container.getBoundingClientRect();
    const width = Math.max(containerRect.width - 40, 900);
    const height = Math.max(containerRect.height - 40, 700);
    d3.select("#chart").selectAll("svg").remove();
    svg = d3.select("#chart")
        .append("svg")
        .attr("width", width)
        .attr("height", height)
        .style("display", "block");
    return { width, height };
}

function drawBubbleChart(data) {
    currentData = data;
    const { width, height } = initializeChart();
    const processedData = data.map(domain => ({
        name: domain.name,
        children: domain.children || []
    }));
    const root = d3.hierarchy({children: processedData})
        .sum(d => d.value || 0)
        .sort((a, b) => b.value - a.value);
    // Stats panel
    const totalPubs = root.value;
    const domainCount = processedData.length;
    const subdomainCount = processedData.reduce((sum, d) => sum + (d.children?.length || 0), 0);
    d3.select("#stats").html(`
        <strong>Dataset Overview</strong><br>
        Domains: ${domainCount}<br>
        Subdomains: ${subdomainCount}<br>
        Total Publications: ${totalPubs}
    `);
    // Pack layout
    const pack = d3.pack()
        .size([width - 60, height - 60])
        .padding(36);
    pack(root);
    // Color palette
    const colorScale = d3.scaleOrdinal([
        "#3498db", "#e74c3c", "#2ecc71", "#f39c12", 
        "#9b59b6", "#1abc9c", "#34495e", "#e67e22",
        "#16a085", "#c0392b", "#8e44ad", "#f1c40f"
    ]);
    // Container group
    const container = svg.append("g")
        .attr("transform", `translate(30, 30)`);
    // Nodes
    const node = container.selectAll("g")
        .data(root.descendants())
        .join("g")
        .attr("class", d => d.depth === 0 ? "root-node" : d.depth === 1 ? "domain-node" : "subdomain-node")
        .attr("transform", d => `translate(${d.x},${d.y})`);
    // Tooltip element
    let tooltip = d3.select("body")
        .append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

    // Circles
    node.append("circle")
        .attr("r", d => d.r)
        .attr("fill", d => {
            if (d.depth === 0) return "transparent";
            if (d.depth === 1) {
                const color = colorScale(d.data.name);
                return d3.color(color).copy({opacity: 0.3});
            }
            return colorScale(d.parent.data.name);
        })
        .attr("stroke", d => d.depth === 1 ? colorScale(d.data.name) : "#fff")
        .attr("stroke-width", d => d.depth === 1 ? 3 : 2)
        .attr("class", "bubble")
        .style("opacity", d => d.depth === 0 ? 0 : (d.depth === 1 ? 0.4 : 0.85))
        .on("mouseover", function(event, d) {
            if (d.depth === 0) return;
            d3.select(this).style("opacity", 1);
            tooltip.transition().duration(200).style("opacity", 1);
            let tooltipContent = "";
            if (d.depth === 1) {
                const totalValue = d.children ? d.children.reduce((sum, child) => sum + child.value, 0) : 0;
                const childCount = d.children ? d.children.length : 0;
                tooltipContent = `
                    <strong>${d.data.name} Domain</strong><br>
                    Subdomains: ${childCount}<br>
                    Total Publications: ${totalValue}
                `;
            } else {
                const percentage = ((d.data.value / currentData.reduce((sum, domain) => 
                    sum + domain.children.reduce((childSum, child) => childSum + child.value, 0), 0)) * 100).toFixed(1);
                tooltipContent = `
                    <strong>${d.data.name}</strong><br>
                    Domain: ${d.parent.data.name}<br>
                    Publications: ${d.data.value}<br>
                    Share: ${percentage}%
                `;
            }
            tooltip.html(tooltipContent)
                .style("left", (event.pageX + 15) + "px")
                .style("top", (event.pageY - 15) + "px");
        })
        .on("mouseout", function(event, d) {
            if (d.depth === 0) return;
            d3.select(this).style("opacity", d => d.depth === 1 ? 0.4 : 0.85);
            tooltip.transition().duration(200).style("opacity", 0);
        });
    // Domain labels
    node.filter(d => d.depth === 1 && d.r > 22)
        .append("text")
        .attr("y", d => -d.r + 8)
        .attr("text-anchor", "middle")
        .attr("class", "domain-label")
        .style("font-size", d => Math.min(d.r * 2/ (d.data.name.length/2), 29) + "px")
        .text(d => {
            const maxLabelLength = Math.floor(d.r * 0.15);
            let label = d.data.name.toUpperCase();
            if (label.length > maxLabelLength) {
                label = label.substring(0, maxLabelLength) + "...";
            }
            return label;
        });
    // Subdomain labels
    node.filter(d => d.depth === 2 && d.r > 12)
        .append("text")
        .attr("text-anchor", "middle")
        .attr("class", "subdomain-label")
        .style("font-size", d => {
            const labelLength = d.data.name.length;
            const maxFontByRadius = d.r * 2.2 / (labelLength);
            return Math.max(12, Math.min(maxFontByRadius, d.r / 2, 22)) + "px";
        })
        .attr("y", -8)
        .text(d => {
            const maxLabelLength = Math.floor(d.r * 0.2);
            let label = d.data.name;
            if (label.length > maxLabelLength) {
                label = label.substring(0, maxLabelLength) + "...";
            }
            return label;
        });
    // Subdomain amount
    node.filter(d => d.depth === 2 && d.r > 18 && d.data.value >= 30)
        .append("text")
        .attr("text-anchor", "middle")
        .attr("class", "subdomain-amount")
        .attr("y", 12)
        .text(d => d.data.value);
}

document.getElementById('download-svg-btn').onclick = function() {
    var svg = document.querySelector('#chart svg');
    if (!svg) return alert('SVG not found!');
    var serializer = new XMLSerializer();
    var source = serializer.serializeToString(svg);
    var blob = new Blob([source], {type: 'image/svg+xml;charset=utf-8'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'bubble-graph.svg';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
};

document.getElementById('download-html-btn').onclick = function() {
    var htmlContent = document.documentElement.outerHTML;
    var blob = new Blob([htmlContent], {type: 'text/html'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'bubble-graph.html';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
};

if (typeof chartData !== 'undefined') {
    drawBubbleChart(chartData.data);
}
window.addEventListener('resize', function() {
    if (currentData) drawBubbleChart(currentData);
});
window.updateData = function(newData) {
    drawBubbleChart(newData);
};
</script>
</body>
</html>